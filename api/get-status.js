import mysql from 'serverless-mysql';

// Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const db = mysql({
  config: {
    host: process.env.DB_HOST || 'sql8.freesqldatabase.com',
    port: process.env.DB_PORT || 3306,
    database: process.env.DB_NAME || 'sql8805485',
    user: process.env.DB_USER || 'sql8805485',
    password: process.env.DB_PASSWORD || 'wpfm3nSAaM'
  }
});

export default async function handler(req, res) {
  // Ø¥Ø¹Ø¯Ø§Ø¯ CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© OPTIONS
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ù€ GET
  if (req.method !== 'GET') {
    return res.status(405).json({
      success: false,
      message: 'Method not allowed'
    });
  }
  
  try {
    console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const results = await db.query(
      'SELECT id, status FROM led_control ORDER BY id'
    );
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ ÙÙŠ Serverless)
    await db.end();
    
    console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', results);
    
    if (!results || results.length === 0) {
      return res.status(404).json({
        success: false,
        message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª',
        timestamp: new Date().toISOString()
      });
    }
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const response = {
      success: true,
      timestamp: new Date().toISOString()
    };
    
    results.forEach(row => {
      response[`led${row.id}`] = row.status;
    });
    
    console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', response);
    
    return res.status(200).json(response);
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø£ÙŠØ¶Ø§Ù‹
    try {
      await db.end();
    } catch (e) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„:', e);
    }
    
    return res.status(500).json({
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…',
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
}
